<!DOCTYPE html>
<html>
<head>
    <title>Monitoring</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.0.25.min.js"></script>
</head>

<body>
    <script type="text/javascript">
        var appId = '263456520445253';
        var roleArn = 'arn:aws:iam::381367247925:role/fbaccess';
        var fbUserId;
            
        //called by FB SDK script
        window.fbAsyncInit = function () {
            console.log ("FB SDK loaded");
            FB.init({
                appId      : appId,
                xfbml      : true,
                version    : 'v2.1'
            });

        };

        // Load the Facebook SDK asynchronously
        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/en_US/all.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function do_aws_stuff(FBresponse) {
            AWS.config.region = 'us-west-2';
            AWS.config.credentials = new AWS.WebIdentityCredentials({
                ProviderId: 'graph.facebook.com',
                RoleArn: roleArn,
                WebIdentityToken: FBresponse.authResponse.accessToken
            });
            var dynamo = new AWS.DynamoDB();
            params = {};
            var now = Date.now();
            var then = now - 20 * 60 * 1000; //20 mins
            params.TableName = "readings";
            params.ScanFilter = {
                "order" : {
                    "AttributeValueList" : [
                        {"N":then.toString()},
                        {"N":now.toString()}
                    ],
                    "ComparisonOperator" : "BETWEEN"
                }
            };
            dynamo.scan (params, function (err, data) {
                console.log ("dynamo returned " + data.Count + " items");
                var time_ordered = data.Items.sort(function(a,b) {
                    return parseInt(a.date.N) - parseInt(b.date.N);
                });
                time_ordered.forEach(function(row) {
                    var reading = "";
                    reading += new Date(parseInt(row.date.N)).toUTCString() + " ";
                    sensors = Object.keys(row).filter(function(el) {
                        // filter out keys that aren't sensors
                        return el != "date" && el != "range";
                    });
                    sensors.forEach(function (sensor) {
                        reading += sensor + " = " + row[sensor].N + ", ";
                    });
                    console.log (reading);
                });
            });
        }
        
        function statusChangeCallback(response) {
            // The response object is returned with a status field that lets the
            // app know the current login status of the person.
            // Full docs on the response object can be found in the documentation
            // for FB.getLoginStatus().
            if (response.status === 'connected') {
                // Logged into your app and Facebook.
                fbUserId = response.authResponse.userID;
                console.log ("FB user is " + fbUserId);
                do_aws_stuff(response);
            } else if (response.status === 'not_authorized') {
              // The person is logged into Facebook, but not your app.
              document.getElementById('status').innerHTML = 'Please log ' +
                'into this app.';
            } else {
              // The person is not logged into Facebook, so we're not sure if
              // they are logged into this app or not.
              document.getElementById('status').innerHTML = 'Please log ' +
                'into Facebook.';
            }
        }
        function checkLoginState() {
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });
        }        


    </script>
    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>
    <div id="status"></div>
</body>
</html>
